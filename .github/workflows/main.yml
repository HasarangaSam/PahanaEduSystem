name: Java CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: pahanaedudb
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -ptestpass -utestuser"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_URL: jdbc:mysql://localhost:3306/pahanaedudb
      DB_USERNAME: testuser
      DB_PASSWORD: testpass

    steps:
    - name: ğŸ“¥ Checkout code from GitHub
      uses: actions/checkout@v3

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ—ï¸ Set up database tables
      run: |
        sleep 10
        mysql -h 127.0.0.1 -u root -prootpass pahanaedudb < schema.sql

    - name: ğŸ§© Download required JARs
      run: |
        mkdir -p lib
        curl -L -o lib/jakarta.servlet-api.jar https://repo1.maven.org/maven2/jakarta/servlet/jakarta.servlet-api/5.0.0/jakarta.servlet-api-5.0.0.jar
        curl -L -o lib/mysql-connector-java.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.3.0/mysql-connector-j-9.3.0.jar
        curl -L -o lib/itext-2.1.7.jar https://repo1.maven.org/maven2/com/lowagie/itext/2.1.7/itext-2.1.7.jar
        curl -L -o lib/jakarta.mail.jar https://repo1.maven.org/maven2/com/sun/mail/jakarta.mail/2.0.1/jakarta.mail-2.0.1.jar
        curl -L -o lib/jakarta.activation.jar https://repo1.maven.org/maven2/jakarta/activation/jakarta.activation-api/2.0.1/jakarta.activation-api-2.0.1.jar
        curl -L -o lib/junit-4.12.jar https://repo1.maven.org/maven2/junit/junit/4.12/junit-4.12.jar
        curl -L -o lib/hamcrest-core-2.2.jar https://repo1.maven.org/maven2/org/hamcrest/hamcrest/2.2/hamcrest-2.2.jar
         # Download Gson 2.13.1
        curl -L -o lib/gson-2.13.1.jar https://repo1.maven.org/maven2/com/google/code/gson/gson/2.13.1/gson-2.13.1.jar

    - name: ğŸ§ª Compile all Java code (including tests)
      run: |
        find src/main/java -name "*.java" > sources.txt
        mkdir -p out
        javac -cp "lib/*" -d out @sources.txt

    - name: âœ… Run all JUnit tests in src/main/java
      run: |
        find out -name "*Test.class" | while read test_file; do
          test_class=$(echo "$test_file" | sed 's|out/||;s|/|.|g;s|.class$||')
          echo "ğŸ§ª Running test: $test_class"
          java -cp "out:lib/*" org.junit.runner.JUnitCore "$test_class"
        done
